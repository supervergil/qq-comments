<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"
    />
    <title>评论</title>
    <script src="https://connect.qq.com/qc_jssdk.js"></script>
    <script src="./lib/js/art-template@4.13.2.js"></script>
    <script src="./lib/js/markdown.min.js"></script>
    <script src="./lib/js/timeago.min.js"></script>
    <link rel="stylesheet" href="./lib/css/gitalk@1.4.1.css" />
  </head>
  <body>
    <div class="container" id="whole-container"></div>
    <script>

        var qqComment = new QQComment("whole-container", {
          appId: "101538993",
          redirectURI: "https://www.zhangyangjun.com/callback/qq",
          userInfo: localStorage.getItem("qq-user-info")
            ? JSON.parse(localStorage.getItem("qq-user-info")).data
            : null,
          openId: localStorage.getItem("qq-user-openid"),
          token: localStorage.getItem("qq-user-token")
        });

        var page = 1;
        var pageSize = 10;

        var getCommentList = function(cb) {
          axios
            .post("/comment/getList", {
              page: page,
              pageSize: pageSize,
              pathname: location.pathname
            })
            .then(function(res) {
              if (res.status === 200) {
                if (res.data.errno === 0) {
                  document.getElementById("comment-count").innerHTML =
                    res.data.data.count;
                  if (res.data.data.data.length < pageSize) {
                    qqComment.hideLoadMore();
                  } else {
                    qqComment.showLoadMore();
                  }
                  if (res.data.data.data.length === 0) {
                    if (cb) {
                      cb();
                    }
                    return false;
                  }
                  qqComment.addComments(
                    res.data.data.data.map(function(item) {
                      return {
                        id: item.id,
                        user: {
                          open_id: item.user_id,
                          name: item.nick_name,
                          avatar: item.avatar,
                          admin: item.is_admin
                        },
                        created_date: item.created_date,
                        content: item.content
                      };
                    })
                  );
                  if (cb) {
                    cb();
                  }
                } else {
                  alert(res.data.errmsg);
                }
              }
            });
        };

        // 点击加载更多回调

        QQComment.onClickLoadMore = function() {
          page += 1;
          qqComment.showLoadMoreLoading();
          getCommentList(function() {
            qqComment.hideLoadMoreLoading();
          });
        };

        // 点击删除回调
        QQComment.onClickRemove = function() {
          var self = this;
          var flag = window.confirm("是否删除这条评论？");
          if (flag) {
            axios
              .post("/comment/removeComment", {
                id: self.getAttribute("data-id"),
                access_token: localStorage.getItem("qq-user-token"),
                openid: localStorage.getItem("qq-user-openid")
              })
              .then(function(res) {
                if (res.status === 200) {
                  if (res.data.errno === 0) {
                    qqComment.clearCommentList();
                    page = 1;
                    getCommentList();
                  } else {
                    alert(res.data.errmsg);
                  }
                }
              });
          }
        };

        // 点击发布评论

        QQComment.onClickPost = function() {
          if (qqComment.isPosting()) {
            return false;
          }
          var content = qqComment.getCommentContent();
          if (!content) {
            return alert("请输入内容！");
          }
          qqComment.showCommentLoading();
          axios
            .post("/comment/addComment", {
              user_id: localStorage.getItem("qq-user-openid"),
              pathname: location.pathname,
              content: content,
              access_token: localStorage.getItem("qq-user-token"),
              openid: localStorage.getItem("qq-user-openid")
            })
            .then(function(res) {
              if (res.status === 200) {
                if (res.data.errno === 0) {
                  qqComment.clearCommentContent();
                  qqComment.clearCommentList();
                  qqComment.hideCommentLoading();
                  page = 1;
                  getCommentList();
                } else {
                  alert(res.data.errmsg);
                }
              }
            });
        };

        // 初始化加载

        getCommentList();

    </script>
  </body>
</html>
